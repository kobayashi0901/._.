<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>"._." Translation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c7d2fe 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #312e81;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            text-align: center;
            color: #4b5563;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-purple {
            background-color: #7c3aed;
            color: white;
        }

        .btn-purple:hover {
            background-color: #6d28d9;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        textarea {
            width: 100%;
            height: 16rem;
            padding: 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            font-size: 1.5rem;
            font-weight: 500;
            color: #1f2937;
            resize: none;
            outline: none;
            line-height: 1.6;
        }

        textarea:focus {
            border-color: #4f46e5;
        }

        .output-box {
            width: 100%;
            height: 16rem;
            padding: 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            overflow-y: auto;
            font-size: 1.5rem;
            font-weight: 500;
            color: #1f2937;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }

        .output-box.empty {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-primary {
            flex: 1;
            background-color: #4f46e5;
            color: white;
            justify-content: center;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            justify-content: center;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-success {
            width: 100%;
            background-color: #059669;
            color: white;
            justify-content: center;
            margin-top: 1rem;
        }

        .btn-success:hover {
            background-color: #047857;
        }

        .btn-success:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

        .placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>"._."ÊöóË™ûÁøªË≠ØÂô®</h1>
        <p class="subtitle" id="modeTitle">"._." ‚Üí Ê≥®Èü≥</p>
        
        <div class="mode-switch">
            <button class="btn btn-purple" onclick="switchMode()">
                <span>üîÑ</span>
                <span>ÂàáÊèõÊ®°Âºè</span>
            </button>
        </div>

        <div class="grid">
            <div class="card">
                <h2 class="card-title" id="inputTitle">Ëº∏ÂÖ•ÊöóË™û</h2>
                <textarea id="inputText" placeholder="Ëº∏ÂÖ•&quot._.&quot,‰∏ÄË°å‰∏ÄÂ≠ó..."></textarea>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="translateText()">
                        <span>‚Üí</span>
                        <span>ÁøªË≠Ø</span>
                    </button>
                    <button class="btn btn-secondary" onclick="reset()">
                        <span>‚Üª</span>
                        <span>Ê∏ÖÈô§</span>
                    </button>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">ÁøªË≠ØÁµêÊûú</h2>
                <div class="output-box empty" id="outputText">
                    <span class="placeholder">ÁøªË≠ØÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°...</span>
                </div>
                <button class="btn btn-success" onclick="copyToClipboard()" id="copyBtn" disabled>
                    <span>üìã</span>
                    <span>Ë§áË£ΩÁµêÊûú</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let mode = 'decode';

        const zhuyin = {
            '.': '„ÑÖ', '..': '„ÑÜ', '...': '„Ñá', '....': '„Ñà',
            '._...': '„Ñâ', '.._..': '„Ñä', '..._.': '„Ñã', '._.._.': '„Ñå',
            '._._._.': '„Ñç', '. ._.': '„Ñé', '. .': '„Ñè',
            '. ..': '„Ñê', '. ...': '„Ñë', '. ....': '„Ñí',
            '. ._...': '„Ñì', '. .._..': '„Ñî', '. ..._.': '„Ñï',
            '. ._.._.': '„Ññ', '. ._._._.': '„Ñó',
            '.. ._.': '„Ñò', '.. .': '„Ñô', '.. ..': '„Ñß',
            '.. ...': '„Ñ®', '.. ....': '„Ñ©', '.. ._...': '„Ñö',
            '.. .._..': '„Ñõ', '.. ..._.': '„Ñú', '.. ._.._.': '„Ñù',
            '.. ._._._.': '„Ñû', '... ._.': '„Ñü', '... .': '„Ñ†',
            '... ..': '„Ñ°', '... ...': '„Ñ¢', '... ....': '„Ñ£',
            '... ._...': '„Ñ§', '... .._..': '„Ñ•', '... ..._.': '„Ñ¶'
        };

        const tones = {
            '.': 'Àâ', '..': 'Àä', '...': 'Àá', '....': 'Àã', '._...': 'Àô'
        };

        const zhuyinReverse = Object.fromEntries(
            Object.entries(zhuyin).map(([k, v]) => [v, k])
        );

        const tonesReverse = Object.fromEntries(
            Object.entries(tones).map(([k, v]) => [v, k])
        );
        
        const zhuyinToNumber = {};
        Object.keys(zhuyin).forEach((key, index) => {
            zhuyinToNumber[key] = index + 1;
        });

        function normalizeCode(code) {
            return code.replace(/‚Ä¶/g, '...');
        }

        function getZhuyin(code) {
            if (zhuyin[code]) return zhuyin[code];
            const normalized = normalizeCode(code);
            return zhuyin[normalized] || null;
        }

        function getTone(code) {
            if (tones[code]) return tones[code];
            const normalized = normalizeCode(code);
            return tones[normalized] || null;
        }

         function getNumber(code) {
            if (zhuyinToNumber[code]) return zhuyinToNumber[code];
            const normalized = normalizeCode(code);
            return zhuyinToNumber[normalized] || null;
        }

        function switchMode() {
            mode = mode === 'decode' ? 'encode' : 'decode';
            document.getElementById('modeTitle').textContent = mode === 'decode' ? '"._." ‚Üí Ê≥®Èü≥' : 'Ê≥®Èü≥ ‚Üí "._."';
            document.getElementById('inputTitle').textContent = mode === 'decode' ? 'Ëº∏ÂÖ•ÊöóË™û' : 'Ëº∏ÂÖ•Ê≥®Èü≥';
            document.getElementById('inputText').placeholder = mode === 'decode' ? 'Ëº∏ÂÖ•"._.",‰∏ÄË°å‰∏ÄÂ≠ó...' : 'Ëº∏ÂÖ•„Ñì„Ñ®Àã„Ñß„Ñ£Àâ,„Ñî„Ñê„Ñê...';
            
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = '<span>üìã</span><span>Ë§áË£ΩÁµêÊûú</span>';
            
            reset();
        }

        function decode() {
            const input = document.getElementById('inputText').value;
            const lines = input.split('\n');
            const results = [];

            for (const line of lines) {
                const tokens = [];
                let current = '';
                let nonCodePrefix = '';
                let nonCodeSuffix = '';
                let codeStarted = false;
                let codeEnded = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (codeEnded) {
                        nonCodeSuffix += char;
                    } else if (char === ' ') {
                        if (current.length > 0) {
                            tokens.push(current);
                            current = '';
                        }
                    } else if (char === '.' || char === '_' || char === '‚Ä¶') {
                        if (!codeStarted) {
                            codeStarted = true;
                        }
                        current += char;
                    } else {
                        if (!codeStarted) {
                            nonCodePrefix += char;
                        } else {
                            if (current.length > 0) {
                                tokens.push(current);
                                current = '';
                            }
                            codeEnded = true;
                            nonCodeSuffix = char;
                        }
                    }
                }
                
                if (current.length > 0 && !codeEnded) {
                    tokens.push(current);
                }

                if (tokens.length === 0) {
                    results.push(line);
                    continue;
                }

                let result = '';
                let success = false;
                const groupCount = tokens.length;

                const lastGroup = tokens[groupCount - 1];
                const isValidTone = getTone(lastGroup) !== null;

                if (isValidTone && (groupCount === 3 || groupCount === 4 || groupCount === 5 || groupCount === 6 || groupCount === 7)) {
                        if (groupCount === 3) {
                        const part1 = tokens[0] + ' ' + tokens[1];
                        const zhuyinChar = getZhuyin(part1);
                        const toneChar = getTone(lastGroup);
                        if (zhuyinChar && toneChar) {
                            result = zhuyinChar + toneChar;
                            success = true;
                        }
                    }
                    else if (groupCount === 4) {
                        const part1 = tokens[0];
                        const part2 = tokens[1] + ' ' + tokens[2];
                        const zhuyin1 = getZhuyin(part1);
                        const zhuyin2 = getZhuyin(part2);
                        const toneChar = getTone(lastGroup);
                        if (zhuyin1 && zhuyin2 && toneChar) {
                            result = zhuyin1 + zhuyin2 + toneChar;
                            success = true;
                        }
                    }
                    else if (groupCount === 5) {
                        const part1 = tokens[0] + ' ' + tokens[1];
                        const part2 = tokens[2] + ' ' + tokens[3];
                        const zhuyin1 = getZhuyin(part1);
                        const zhuyin2 = getZhuyin(part2);
                        const toneChar = getTone(lastGroup);
                        if (zhuyin1 && zhuyin2 && toneChar) {
                            result = zhuyin1 + zhuyin2 + toneChar;
                            success = true;
                        }
                    }
                    else if (groupCount === 6) {
                        const part1 = tokens[0];
                        const part2 = tokens[1] + ' ' + tokens[2];
                        const part3 = tokens[3] + ' ' + tokens[4];
                        const zhuyin1 = getZhuyin(part1);
                        const zhuyin2 = getZhuyin(part2);
                        const zhuyin3 = getZhuyin(part3);
                        const toneChar = getTone(lastGroup);
                        if (zhuyin1 && zhuyin2 && zhuyin3 && toneChar) {
                            result = zhuyin1 + zhuyin2 + zhuyin3 + toneChar;
                            success = true;
                        }
                    }
                    else if (groupCount === 7) {
                        const part1 = tokens[0] + ' ' + tokens[1];
                        const part2 = tokens[2] + ' ' + tokens[3];
                        const part3 = tokens[4] + ' ' + tokens[5];
                        const zhuyin1 = getZhuyin(part1);
                        const zhuyin2 = getZhuyin(part2);
                        const zhuyin3 = getZhuyin(part3);
                        const toneChar = getTone(lastGroup);
                        if (zhuyin1 && zhuyin2 && zhuyin3 && toneChar) {
                            result = zhuyin1 + zhuyin2 + zhuyin3 + toneChar;
                            success = true;
                        }
                    }
                }

                if (!success) {
                    for (const token of tokens) {
                        const num = getNumber(token);
                        if (num) {
                            result += num;
                        } else {
                            result += token;
                        }
                    }
                }

                results.push(nonCodePrefix + result + nonCodeSuffix);
            }

            return results.join('\n');
        }

        function encode() {
            const text = document.getElementById('inputText').value.trim();
            const results = [];
            let parts = [];
            let pendingPunctuation = '';

            for (let i = 0; i < text.length; i++) {
                const char = text[i];

                if (zhuyinReverse[char]) {
                    const code = zhuyinReverse[char];
                    if (code.includes(' ')) {
                        const splitCode = code.split(' ');
                        parts.push(splitCode[0]);
                        parts.push(splitCode[1]);
                    } else {
                        parts.push(code);
                    }
                } else if (tonesReverse[char]) {
                    parts.push(tonesReverse[char]);

                    let j = i + 1;
                    while (j < text.length) {
                        const nextChar = text[j];
                        if (nextChar.trim() === '' || nextChar === '\n') {
                            j++;
                            continue;
                        }
                        if (!zhuyinReverse[nextChar] && !tonesReverse[nextChar]) {
                            pendingPunctuation += nextChar;
                            i = j;
                            j++;
                        } else {
                            break;
                        }
                    }

                    if (parts.length > 0) {
                        let line = parts.join(' ');
                        if (pendingPunctuation) {
                            line += ' ' + pendingPunctuation;
                            pendingPunctuation = '';
                        }
                        results.push(line);
                        parts = [];
                    }
                } else if (char.trim() === '' || char === '\n') {
                    continue;
                } else {
                    if (parts.length === 0 && results.length === 0) {
                        results.push(char);
                    } else {
                        pendingPunctuation += char;
                    }
                }
            }

            if (parts.length > 0) {
                let line = parts.join(' ');
                if (pendingPunctuation) {
                    line += ' ' + pendingPunctuation;
                }
                results.push(line);
            } else if (pendingPunctuation) {
                results.push(pendingPunctuation);
            }

            return results.join('\n');
        }

        function translateText() {
            const output = mode === 'decode' ? decode() : encode();
            const outputBox = document.getElementById('outputText');
            if (output) {
                outputBox.textContent = output;
                outputBox.className = 'output-box';
            } else {
                outputBox.innerHTML = '<span class="placeholder">ÁøªË≠ØÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°...</span>';
                outputBox.className = 'output-box empty';
            }
            document.getElementById('copyBtn').disabled = !output;
        }

        function reset() {
            document.getElementById('inputText').value = '';
            const outputBox = document.getElementById('outputText');
            outputBox.innerHTML = '<span class="placeholder">ÁøªË≠ØÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°...</span>';
            outputBox.className = 'output-box empty';
            document.getElementById('copyBtn').disabled = true;
            
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = '<span>üìã</span><span>Ë§áË£ΩÁµêÊûú</span>';
        }

        function copyToClipboard() {
            const output = document.getElementById('outputText').textContent;
            navigator.clipboard.writeText(output).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>‚úì</span><span>Â∑≤Ë§áË£Ω!</span>';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }
    </script>
</body>
</html>

